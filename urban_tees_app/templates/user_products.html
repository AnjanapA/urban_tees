{% extends 'user_layout.html' %}
{% load static %}
{% block content %}

<div class="container mt-4">
    <div class="row g-3" id="product-container">
        {% for pro in item %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex product-card" data-category="{{ pro.category }}">
            <div class="card w-100 position-relative">
                <a href="{% url 'user_single_product' pro.id %}">
                    <img src="{% static pro.item_image1 %}" class="card-img-top" alt="{{ pro.item_name }}"
                        style="max-height: 200px; object-fit: contain;">
                </a>
                <div class="card-body">
                    <h5 class="card-title">{{ pro.item_name }}</h5>
                    <p class="card-text">{{ pro.item_description }}</p>
                </div>
                <div>
                    <span class="btn btn-outline-dark btn-sm disabled">S</span>
                    <span class="btn btn-outline-dark btn-sm disabled">M</span>
                    <span class="btn btn-outline-dark btn-sm disabled">L</span>
                    <span class="btn btn-outline-dark btn-sm disabled">XL</span>
                </div>
                <ul class="d-flex justify-content-between me-5 list-unstyled px-3">
                    <li class="text-danger fs-5">{{ pro.new_price }}</li>
                    <li class="fs-6"><del>{{ pro.old_price }}</del></li>
                    <li class="text-success fs-5">{{ pro.offer }}%</li>
                </ul>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="grid text-center container-fluid mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
</div>

<div id="wishlist-popup"
    style="display: none; position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 12px 20px; border-radius: 6px; font-size: 14px; z-index: 1000;">
    Product added to wishlist
</div>

{% endblock %}

{% block script %}
<script>
    const products = [
        {% for pro in item %}
    {
        id: "{{ pro.id }}",
            item_name: "{{ pro.item_name|escapejs }}",
                item_description: "{{ pro.item_description|escapejs }}",
                    item_image: "{% static pro.item_image1 %}",
                        new_price: "{{ pro.new_price }}",
                            old_price: "{{ pro.old_price }}",
                                offer: "{{ pro.offer }}"
    },
    {% endfor %}
    ];

    const itemsPerPage = 8;
    let currentPage = 1;

    function renderProducts() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = products.slice(start, end);

        const container = document.getElementById('product-container');
        container.innerHTML = '';

        paginatedItems.forEach(pro => {
            container.innerHTML += `
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex">
                    <div class="card w-100 position-relative">
                        <a href="/product/${pro.id}">
                            <img src="${pro.item_image}" class="card-img-top" alt="product image"
                                style="height: auto; max-height: 200px; object-fit: contain;">
                        </a>
                        <div class="card-body">
                            <h5 class="card-title">${pro.item_name}</h5>
                            <p class="card-text">${pro.item_description}</p>
                        </div>
                        <div>
                            <span class="btn btn-outline-dark btn-sm disabled">S</span>
                            <span class="btn btn-outline-dark btn-sm disabled">M</span>
                            <span class="btn btn-outline-dark btn-sm disabled">L</span>
                            <span class="btn btn-outline-dark btn-sm disabled">XL</span>
                        </div>
                        <ul class="d-flex justify-content-between me-5 list-unstyled px-3">
                            <li class="text-danger fs-5">${pro.new_price}</li>
                            <li class="fs-6"><del>${pro.old_price}</del></li>
                            <li class="text-success fs-5">${pro.offer}%</li>
                        </ul>
                        <ul class="d-flex justify-content-between me-5 list-unstyled px-3">
                            <li>
                                <a href="#" class="wishlist-btn" data-product-id="${pro.id}" id="wishlist-btn"
                                   style="display: inline-block; padding: 8px 12px; border: 2px solid green; color: green; background-color: transparent; border-radius: 5px; text-decoration: none;">
                                   <i class="bi bi-heart"></i>
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'cart_page' %}"
                                   style="display: inline-block; padding: 8px 12px; border: 2px solid red; color: red; background-color: transparent; border-radius: 5px; text-decoration: none;">
                                   <i class="bi bi-cart-fill"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            `;
        });

        attachWishlistEventHandlers();
    }

    function renderPagination() {
        const totalPages = Math.ceil(products.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        if (!pagination) return;

        pagination.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>
            `;
        }
    }

    function goToPage(page) {
        currentPage = page;
        renderProducts();
        renderPagination();
    }

    function showWishlistPopup() {
        const popup = document.getElementById("wishlist-popup");
        popup.style.display = "block";
        setTimeout(() => {
            popup.style.display = "none";
        }, 3000);
    }

    function attachWishlistEventHandlers() {
        const wishlistButtons = document.querySelectorAll("wishlist-btn");

        wishlistButtons.forEach(button => {
            button.addEventListener("click", function (event) {
                event.preventDefault();

                const targetButton = event.currentTarget;
                const productId = targetButton.getAttribute('data-product-id');

                fetch(`/wishlist/session/add/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({ product_id: productId }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            showWishlistPopup();

                            targetButton.style.backgroundColor = "orange";
                            targetButton.style.borderColor = "orange";
                            targetButton.style.color = "white";
                            targetButton.style.pointerEvents = "none";
                            targetButton.style.opacity = "0.7";
                        } else {
                            alert("Failed to add to wishlist.");
                        }
                    });
            });
        });
    }
    function getCSRFToken() {
        let name = "csrftoken";
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    renderProducts();
    renderPagination();
</script>
{% endblock %}