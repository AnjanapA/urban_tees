{% extends 'user_layout.html' %}
{% load static %}
{% load cart_extras %}
{% block content %}

<div class="container mt-4">
    <div class="row g-3" id="product-container">
    </div>
</div>

<div class="grid text-center container-fluid mt-4">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="pagination">
        </ul>
    </nav>
</div>

<!-- <div id="cart-popup"
    style="display: none; position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 12px 20px; border-radius: 6px; font-size: 14px; z-index: 1000;">
    Product added to cart
</div> -->

<div id="wishlist-popup"
    style="display: none; position: fixed; bottom: 20px; right: 20px; background-color: #333; color: #fff; padding: 12px 20px; border-radius: 6px; font-size: 14px; z-index: 1000;">
    Product added to wishlist
</div>

<div id="cart-sidebar" style="
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100%;
    background-color: #fff;
    box-shadow: -2px 0 10px rgba(0,0,0,0.3);
    padding: 20px;
    z-index: 9999;
    transition: right 0.3s ease-in-out;
    overflow-y: auto;
">
    <button onclick="closeSidebar()" style="
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
    ">&times;</button>

    <div id="sidebar-content">
    </div>
</div>


{% endblock %}

{% block script %}
<script>
    const products = [
        {% for pro in item %}
    {
        id: "{{ pro.id }}",
        item_name : "{{ pro.item_name|escapejs }}",
        item_description: "{{ pro.item_description|escapejs }}",
        item_image: "{% static pro.item_image1 %}",
        new_price: "{{ pro.new_price }}",
        old_price: "{{ pro.old_price }}",
        offer: "{{ pro.offer }}"
    },
    {% endfor %}
    ];

    const itemsPerPage = 8;
    let currentPage = 1;

    function renderProducts() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = products.slice(start, end);

        const container = document.getElementById('product-container');
        container.innerHTML = '';

        paginatedItems.forEach(pro => {
            container.innerHTML += `
                <div class="col-12 col-sm-6 col-md-4 col-lg-3 d-flex">
                    <div class="card w-100 position-relative">
                        <a href="/product/${pro.id}">
                            <img src="${pro.item_image}" class="card-img-top" alt="product image"
                                style="height: auto; max-height: 200px; object-fit: contain;">
                        </a>
                        <div class="card-body">
                            <h5 class="card-title">${pro.item_name}</h5>
                            <p class="card-text">${pro.item_description}</p>
                        </div>
                        <div id="size">
                            <span class="btn btn-outline-dark btn-sm disabled">S</span>
                            <span class="btn btn-outline-dark btn-sm disabled">M</span>
                            <span class="btn btn-outline-dark btn-sm disabled">L</span>
                            <span class="btn btn-outline-dark btn-sm disabled">XL</span>
                        </div>
                        <ul class="d-flex justify-content-between me-5 list-unstyled px-3">
                            <li class="text-danger fs-5">${pro.new_price}</li>
                            <li class="fs-6"><del>${pro.old_price}</del></li>
                            <li class="text-success fs-5">${pro.offer}%</li>
                        </ul>
                        <ul class="d-flex justify-content-between me-5 list-unstyled px-3">
                            <li>
                                <a href="#" class="wishlist-btn" data-product-id="${pro.id}"
                                   style="display: inline-block; padding: 8px 12px; border: 2px solid green; color: green; background-color: transparent; border-radius: 5px; text-decoration: none;">
                                   <i class="bi bi-heart"></i>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="cart-btn" data-product-id="${pro.id}" id="cart"
                                style="display: inline-block; padding: 8px 12px; border: 2px solid red; color: red; background-color: transparent; border-radius: 5px; text-decoration: none;">
                                <i class="bi bi-cart-fill"></i>
                                </a>                            
                                </li>
                        </ul>
                    </div>

                </div>
            `;
        });

        attachWishlistEventHandlers();
        attachCartEventHandlers();
    }

    function renderPagination() {
        const totalPages = Math.ceil(products.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        if (!pagination) return;

        pagination.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                </li>
            `;
        }
    }

    function goToPage(page) {
        currentPage = page;
        renderProducts();
        renderPagination();
    }

    function showWishlistPopup() {
        const popup = document.getElementById("wishlist-popup");
        popup.style.display = "block";
        setTimeout(() => {
            popup.style.display = "none";
        }, 3000);
    }

    function attachWishlistEventHandlers() {
        const wishlistButtons = document.querySelectorAll(".wishlist-btn");

        wishlistButtons.forEach(button => {
            button.addEventListener("click", function (event) {
                event.preventDefault();

                const targetButton = event.currentTarget;
                const productId = targetButton.getAttribute('data-product-id');

                fetch(`/wishlist_page/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: new URLSearchParams({
                        id: productId,
                        action: "add"
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            showWishlistPopup();

                            targetButton.style.backgroundColor = "orange";
                            targetButton.style.borderColor = "orange";
                            targetButton.style.color = "white";
                            targetButton.style.pointerEvents = "none";
                            targetButton.style.opacity = "0.7";
                        } else {
                            alert("Failed to add to wishlist.");
                        }
                    });
            });
        });
    }

    function sizePopup() {
        const popup = document.getElementById("size");
        popup.style.display = "block";
        setTimeout(() => {
            popup.style.borderColor = "orange";
        }, 3000);
    }

    let selectedSize = null;

    function attachCartEventHandlers() {
        const cartButtons = document.querySelectorAll(".cart-btn");

        cartButtons.forEach(button => {
            button.addEventListener("click", function (event) {
                event.preventDefault();

                const card = button.closest('.card');
                const sizeButtons = card.querySelectorAll('#size span');

                sizeButtons.forEach(btn => {
                    btn.classList.remove('disabled');
                    btn.style.border = "2px solid orange";
                    btn.style.color = "orange";
                    btn.style.cursor = "pointer";

                    btn.onclick = () => {
                        selectedSize = btn.textContent;
                        openSidebar(card, button.getAttribute('data-product-id'), selectedSize);
                    };
                });

                button.textContent = "Select Size";
                button.style.backgroundColor = "orange";
                button.style.borderColor = "orange";
                button.style.color = "white";
            });
        });
    }

    function openSidebar(card, productId, size) {
        const sidebar = document.getElementById("cart-sidebar");
        const content = document.getElementById("sidebar-content");

        const img = card.querySelector("img").src;
        const name = card.querySelector(".card-title").textContent;
        const desc = card.querySelector(".card-text").textContent;
        const price = card.querySelector(".text-danger").textContent;

        content.innerHTML = `
        <div style="text-align: center;">
            <img src="${img}" alt="Product Image" style="width: 100px; height: auto; object-fit: contain; margin-bottom: 10px;">
        </div>
        <h5 style="margin-top: 10px;">${name}</h5>
        <p>${desc}</p>
        <p><strong>Selected Size:</strong> ${size}</p>
        <label for="quantity"><strong>Quantity:</strong></label>
        <select id="quantity" style="display: block; width: 100px; margin-bottom: 10px; padding: 5px;">
            ${[1, 2, 3, 4, 5].map(n => `<option value="${n}">${n}</option>`).join("")}
        </select>
        <p><strong>Price:</strong> â‚¹${price}</p>
        <button onclick="addToCart('${productId}', '${size}', ${price})" id="add-cart-btn" style="
            padding: 10px 20px;
            background-color: green;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        ">OK</button>
    `;

        sidebar.style.right = "0";
    }

    function closeSidebar() {
        document.getElementById("cart-sidebar").style.right = "-400px";
        selectedSize = null;
    }

    function addToCart(productId, size, price) {
        const quantity = document.getElementById("quantity").value;

        fetch(`/cart_page`, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCSRFToken()
            },
            body: new URLSearchParams({
                id: productId,
                size: size,
                quantity: quantity,
                price: price,
                action: "add"
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const button = document.getElementById("add-cart-btn");
                    button.textContent = "View in Cart";
                    button.style.backgroundColor = "blue";
                    button.onclick = () => window.location.href = "/cart_page";
                } else {
                    alert("Failed to add to cart.");
                }
            });

        setTimeout(() => closeSidebar(), 1500);
    }

    function getCSRFToken() {
        let name = "csrftoken";
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    renderProducts();
    renderPagination();
</script>
{% endblock %}